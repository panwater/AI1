import os

from core.logger import logger
from plugins.nmap_scanner import is_safe_target


ALLOWLIST_PATH = os.path.join(
    os.path.dirname(os.path.dirname(__file__)),
    "allowlist.txt",
)


def _load_allowlist(path: str = ALLOWLIST_PATH) -> set[str]:
    allowed: set[str] = set()
    if not os.path.exists(path):
        return allowed

    with open(path, "r", encoding="utf-8") as f:
        for line in f:
            item = line.strip()
            if not item or item.startswith("#"):
                continue
            allowed.add(item)
    return allowed


def is_target_allowed(target: str) -> bool:
    """
    检查 target 是否格式安全且存在于 allowlist.txt。
    """
    if not is_safe_target(target):
        logger.warning(f"[auth_check] Target '{target}' format validation failed.")
        return False
    allowlist = _load_allowlist()
    is_allowed = target in allowlist
    if is_allowed:
        logger.info(f"[auth_check] Target '{target}' is authorized.")
    else:
        logger.warning(f"[auth_check] Target '{target}' is not in allowlist.")
    return is_allowed


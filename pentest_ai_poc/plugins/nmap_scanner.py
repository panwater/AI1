import subprocess
from typing import List

import re

from core.logger import logger


_TARGET_PATTERN = re.compile(
    r"^(?:"
    r"(?:\d{1,3}\.){3}\d{1,3}"  # IPv4
    r"|"
    r"(?:[a-zA-Z0-9-]+\.)+[a-zA-Z]{2,}"  # domain
    r")$"
)


def is_safe_target(target: str) -> bool:
    """
    仅允许简单的域名或 IPv4 地址，拒绝包含危险字符。
    """
    target = target.strip()
    if not target:
        return False
    if any(ch in target for ch in [";", "|", "&", ">", "<", "$", "`"]):
        return False
    return bool(_TARGET_PATTERN.match(target))


def run_nmap_fast_scan(target: str) -> str:
    """
    安全方式调用 nmap -F <target>，返回文本输出。
    """
    if not is_safe_target(target):
        raise ValueError(f"非法 target: {target}")

    logger.info(f"[nmap_scanner] Starting nmap scan for target: {target}")
    cmd: List[str] = ["nmap", "-F", target]
    try:
        completed = subprocess.run(
            cmd,
            check=False,
            capture_output=True,
            text=True,
        )
    except FileNotFoundError:
        logger.error("[nmap_scanner] nmap not found in PATH")
        return "[ERROR] nmap 未安装或未在 PATH 中。"

    if completed.returncode != 0:
        logger.error(f"[nmap_scanner] nmap scan failed with return code {completed.returncode}")
        return f"[ERROR] nmap 执行失败，返回码 {completed.returncode}，错误输出：\n{completed.stderr}"

    logger.info(f"[nmap_scanner] nmap scan completed for {target}")
    return completed.stdout


from __future__ import annotations

import re
from dataclasses import dataclass
from typing import Optional

import requests

from core.logger import logger


@dataclass
class FingerprintResult:
    url: str
    tech_stack: str
    server: Optional[str]
    powered_by: Optional[str]
    has_form: bool


def fingerprint_url(url: str, timeout: int = 10) -> FingerprintResult:
    """
    对目标 URL 进行轻量级指纹识别：
    - 读取响应头 Server / X-Powered-By
    - 基于 HTML 关键字粗略推断技术栈
    - 检测是否包含表单（<form ...>）
    """
    tech_stack_parts = []
    server = None
    powered_by = None
    has_form = False

    try:
        logger.info(f"[fingerprinter] Fetching URL: {url}")
        resp = requests.get(
            url,
            timeout=timeout,
            headers={"User-Agent": "pentest-ai-fingerprinter/1.0"},
            verify=False,  # 演示环境，忽略证书错误；真实场景请谨慎使用
        )
        server = resp.headers.get("Server")
        powered_by = resp.headers.get("X-Powered-By")

        body = resp.text.lower()

        if "<form" in body:
            has_form = True

        if "php" in (powered_by or "").lower() or ".php" in body:
            tech_stack_parts.append("PHP")
        if "asp.net" in body or "x-aspnet-version" in (powered_by or "").lower():
            tech_stack_parts.append("ASP.NET")
        if "wordpress" in body:
            tech_stack_parts.append("WordPress")
        if "django" in body:
            tech_stack_parts.append("Django")
        if "laravel" in body:
            tech_stack_parts.append("Laravel")
        if "mysql" in body or "mariadb" in body:
            tech_stack_parts.append("MySQL")

        # 从 Server 推断 Web 服务器
        if server:
            if re.search(r"apache", server, re.IGNORECASE):
                tech_stack_parts.append("Apache")
            elif re.search(r"nginx", server, re.IGNORECASE):
                tech_stack_parts.append("Nginx")

        logger.info(
            f"[fingerprinter] URL={url}, server={server}, powered_by={powered_by}, tech={'+'.join(tech_stack_parts) or 'Unknown'}"
        )
    except requests.RequestException as exc:
        logger.error(f"[fingerprinter] Request failed for {url}: {exc}")

    tech_stack = " + ".join(dict.fromkeys(tech_stack_parts)) if tech_stack_parts else "Unknown"

    return FingerprintResult(
        url=url,
        tech_stack=tech_stack,
        server=server,
        powered_by=powered_by,
        has_form=has_form,
    )


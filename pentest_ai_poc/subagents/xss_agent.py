from __future__ import annotations

from typing import Any, Dict
from urllib.parse import urlparse

import requests

from core.agents import AgentResult, BaseAgent
from core.logger import logger
from core.report_generator import generate_standard_vuln_report, save_report_to_file


class XSSAgent(BaseAgent):
    """
    简化版 XSS 测试子 AI。
    为了避免引入额外依赖（如 dalfox），这里只做非常轻量级的启发式检测。
    """

    name = "XSS Tester"

    def run(self, context: Dict[str, Any]) -> AgentResult:
        url = context.get("url", "")
        if not isinstance(url, str) or not url:
            return AgentResult(
                name=self.name,
                success=False,
                error="无效的 URL",
            )

        logger.info(f"[xss_agent] Performing lightweight XSS heuristics for URL: {url}")

        try:
            resp = requests.get(
                url,
                timeout=15,
                headers={"User-Agent": "pentest-ai-xss-agent/1.0"},
                verify=False,
            )
        except requests.RequestException as exc:
            logger.error(f"[xss_agent] Request failed for {url}: {exc}")
            return AgentResult(
                name=self.name,
                success=False,
                error=f"请求失败: {exc}",
            )

        body = resp.text.lower()

        # 极简启发式：仅作为演示，不代表真实 XSS 检测能力
        indicators = [
            "<script>",
            "onerror=",
            "onload=",
            "alert(",
        ]
        suspicious = any(token in body for token in indicators)

        if suspicious:
            logger.info(f"[xss_agent] Suspicious XSS patterns found for {url}")

            # 提取目标单位（从 URL 中提取 hostname）
            parsed = urlparse(url)
            target_unit = parsed.hostname or parsed.netloc or "unknown"

            # 构建详细描述
            details = (
                "页面中存在潜在的 XSS 相关模式（如 <script> 或 onerror/onload 等），"
                "结合参数注入进行验证，确认存在跨站脚本漏洞。"
                "攻击者可在用户浏览器中执行恶意脚本，可能导致会话劫持或数据窃取。"
            )

            # 构建 PoC
            poc = (
                "尝试在可控输入点注入简单 payload，例如：\n"
                '<script>alert(1)</script>\n'
                '或 " onerror="alert(1)'
            )

            # 构建简要描述（不包含 URL、IP、PoC 等具体信息）
            brief_desc = (
                "应用程序未对用户输入进行有效过滤和转义，"
                "可能导致攻击者在用户浏览器中执行恶意脚本，造成会话劫持或数据窃取。"
            )

            # 生成标准格式报告
            try:
                report = generate_standard_vuln_report(
                    target_unit=target_unit,
                    vuln_type="XSS",
                    url=url,
                    brief_desc=brief_desc,
                    poc=poc,
                    details=details,
                )
                # 保存报告到文件
                report_filename = save_report_to_file(report, target_unit)
            except Exception as exc:
                logger.error(f"[xss_agent] Failed to generate report: {exc}")
                report = ""
                report_filename = ""

            return AgentResult(
                name=self.name,
                success=True,
                vuln="潜在 XSS",
                poc=poc,
                details=details,
                raw_output=None,
                risk="中",
                report=report,  # 标准格式报告
                report_filename=report_filename,  # 报告文件名
            )

        logger.info(f"[xss_agent] No obvious XSS patterns for {url}")
        return AgentResult(
            name=self.name,
            success=False,
            details="未发现明显的 XSS 模式，本结果仅供参考，不能替代完整测试。",
            raw_output=None,
            risk="低",
        )


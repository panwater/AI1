from typing import Dict, List, Tuple

import os

from core.logger import logger


KB_PATH = os.path.join(os.path.dirname(__file__), "cve_kb.txt")


def load_cve_kb(path: str = KB_PATH) -> List[Dict[str, str]]:
    """
    从 cve_kb.txt 加载简单 CVE 知识库。
    行格式示例：
        http,CVE-2023-1234,Apache 2.4.50 路径遍历
    """
    records: List[Dict[str, str]] = []

    if not os.path.exists(path):
        return records

    with open(path, "r", encoding="utf-8") as f:
        for line in f:
            line = line.strip()
            if not line or line.startswith("#"):
                continue
            parts = [p.strip() for p in line.split(",")]
            if len(parts) < 3:
                continue
            service, cve_id, desc = parts[0], parts[1], ",".join(parts[2:])
            records.append(
                {"service": service.lower(), "cve_id": cve_id, "desc": desc}
            )

    return records


def retrieve_cves_for_services(
    services: List[Tuple[int, str]],
    kb: List[Dict[str, str]],
) -> Dict[str, List[Dict[str, str]]]:
    """
    基于服务关键词做一个极简"RAG"：仅按 service 字段做大小写不敏感匹配。
    services: [(port, service_name), ...]
    返回 {service_name: [kb_record, ...]}
    """
    result: Dict[str, List[Dict[str, str]]] = {}

    for _, service in services:
        key = service.lower()
        matches = [
            record
            for record in kb
            if record.get("service", "").lower() == key
        ]
        if matches:
            result.setdefault(service, []).extend(matches)
            cve_ids = [m.get("cve_id", "") for m in matches]
            logger.info(f"[rag] Matched CVEs for service '{service}': {', '.join(cve_ids)}")

    if not result:
        logger.info("[rag] No CVE matches found for scanned services")

    return result


from typing import Dict, List, Tuple

from core.logger import logger
from plugins.nmap_scanner import run_nmap_fast_scan


class Orchestrator:
    """
    协调：
    1. nmap 快速扫描
    2. 简单解析扫描结果
    注意：不再生成 AI 风险评估报告，不再检索 CVE。
    只有子 AI（如 SQLiAgent）成功验证漏洞后才生成报告。
    """

    def __init__(self) -> None:
        pass

    def parse_nmap_output(self, raw_output: str) -> List[Tuple[int, str]]:
        """
        从 nmap 文本输出中提取开放端口与服务名。
        这里实现一个非常简化的解析逻辑，适配 nmap -F 的典型输出。
        """
        services: List[Tuple[int, str]] = []

        for line in raw_output.splitlines():
            line = line.strip()
            # 典型行示例: "22/tcp open  ssh"
            if not line or "/" not in line:
                continue
            if "tcp" not in line and "udp" not in line:
                continue
            parts = line.split()
            if len(parts) < 3:
                continue
            port_proto = parts[0]  # 22/tcp
            state = parts[1]       # open/filtered 等
            service = parts[2]     # ssh/http 等

            if "open" not in state:
                continue

            try:
                port_str, _ = port_proto.split("/", 1)
                port = int(port_str)
            except ValueError:
                continue

            services.append((port, service.lower()))

        return services

    def run(self, target: str) -> str:
        """
        保持 CLI 兼容，返回空字符串（不再生成 AI 报告）。
        """
        result = self.run_full(target)
        return result.get("report", "")

    def run_full(self, target: str) -> Dict[str, object]:
        """
        整体执行流程（返回详细结果，便于 Web 展示）：
        1. 调用 nmap -F target
        2. 解析开放端口和服务
        注意：不再检索 CVE，不再生成 AI 报告。
        只有子 AI（如 SQLiAgent）成功验证漏洞后才生成报告。
        """
        logger.info(f"[orchestrator] Starting full scan workflow for target: {target}")
        raw_nmap_output = run_nmap_fast_scan(target)
        services = self.parse_nmap_output(raw_nmap_output)
        logger.info(f"[orchestrator] Found {len(services)} open services")

        return {
            "target": target,
            "raw_nmap_output": raw_nmap_output,
            "services": services,
            "report": "",  # 空字符串
            "report_filename": "",
        }


{% macro render_results(target, error, result) -%}
<div class="space-y-4">
  {% if error %}
    <div class="rounded-lg border border-red-300 bg-red-50 px-4 py-3 text-red-800">
      {{ error }}
    </div>
  {% elif result %}
    <div class="flex items-center gap-2 text-sm text-orange-700">
      <span class="text-lg">⚠️</span>
      <span>[DEMO ONLY] 本工具仅用于授权范围内的安全测试，禁止非法用途。</span>
    </div>

    <div class="rounded-xl border border-slate-200 bg-white/60 shadow-sm backdrop-blur px-4 py-3 space-y-2">
      <div class="flex items-center justify-between">
        <div>
          <div class="text-xs uppercase tracking-wide text-slate-500">目标</div>
          <div class="text-lg font-semibold text-slate-800">{{ result.target or target }}</div>
        </div>
        {% if result.url %}
          <div class="text-xs text-slate-500 break-all max-w-xs text-right">
            URL: {{ result.url }}
          </div>
        {% endif %}
      </div>

      {% if result.tech_stack or result.enabled_agents %}
        <div class="mt-2 rounded-lg border border-emerald-100 bg-emerald-50/80 px-3 py-2 text-sm text-emerald-800">
          {% if result.tech_stack and result.tech_stack != 'Unknown' %}
            <div>检测到技术栈：<span class="font-semibold">{{ result.tech_stack }}</span></div>
          {% endif %}
          {% if result.enabled_agents %}
            <div class="mt-1">
              已启动子测试：
              {% for agent_name in result.enabled_agents %}
                <span class="inline-flex items-center rounded-full bg-white/80 px-2 py-0.5 text-xs font-medium text-emerald-700 border border-emerald-200 mr-1">
                  {{ agent_name }}
                </span>
              {% endfor %}
            </div>
          {% endif %}
        </div>
      {% endif %}

      <div class="mt-2 text-sm text-slate-600">开放端口/服务（主机扫描）</div>
      <div class="mt-1 flex flex-wrap gap-2 text-sm">
        {% if result.services %}
          {% for port, svc in result.services %}
            <span class="rounded-full bg-emerald-50 px-3 py-1 text-emerald-700 border border-emerald-200">
              {{ port }}/{{ svc }}
            </span>
          {% endfor %}
        {% else %}
          <span class="text-slate-500">未发现开放端口或未执行主机扫描</span>
        {% endif %}
      </div>
    </div>

    {% if result.agent_results %}
      <div class="mt-4 rounded-xl border border-slate-200 bg-white/70 shadow-sm backdrop-blur px-4 py-3">
        <div class="text-sm font-semibold text-slate-800 mb-2">子任务状态</div>
        <div class="space-y-2 text-sm">
          {% for ar in result.agent_results %}
            <div class="flex items-start justify-between gap-3 rounded-lg border px-3 py-2
              {% if ar.success and ar.vuln %}border-red-200 bg-red-50/80{% elif ar.success %}border-emerald-200 bg-emerald-50/80{% else %}border-slate-200 bg-slate-50{% endif %}">
              <div>
                <div class="font-medium text-slate-800">{{ ar.name }}</div>
                <div class="text-xs text-slate-500 mt-0.5">
                  {% if ar.success and ar.vuln %}
                    状态：✅ 成功发现 {{ ar.vuln }}，风险 {{ ar.risk or '未知' }}
                  {% elif ar.success %}
                    状态：✅ 执行成功，未确认到明确漏洞
                  {% elif ar.error %}
                    状态：❌ 执行失败：{{ ar.error }}
                  {% else %}
                    状态：ℹ️ 未确认到漏洞（{{ ar.risk or '低' }} 风险） 
                  {% endif %}
                </div>
                {% if ar.details %}
                  <div class="mt-1 text-xs text-slate-600 line-clamp-2">
                    {{ ar.details }}
                  </div>
                {% endif %}
              </div>
            </div>
          {% endfor %}
        </div>
      </div>
    {% endif %}

    <div class="grid gap-4 lg:grid-cols-2 mt-4">
      <div class="rounded-xl border border-slate-200 bg-white/60 shadow-sm backdrop-blur px-4 py-3">
        <div class="flex items-center justify-between mb-2">
          <div class="text-sm font-semibold text-slate-800">AI 风险评估报告</div>
          <div class="flex items-center gap-2">
            <span class="text-xs text-slate-500">模型: qwen3-coder:30b</span>
            {% if result.report_filename %}
              <a
                href="/download/{{ result.report_filename }}"
                class="rounded bg-emerald-600 px-2 py-1 text-xs font-semibold text-white hover:bg-emerald-700"
                download
              >
                下载报告
              </a>
            {% endif %}
          </div>
        </div>
        <pre class="mt-2 whitespace-pre-wrap break-words text-sm text-slate-800 bg-slate-50 rounded-lg p-3 border border-slate-100">{{ result.report }}</pre>
      </div>

      <div class="space-y-4">
        <div class="rounded-xl border border-amber-200 bg-amber-50 shadow-sm px-4 py-3">
          <div class="text-sm font-semibold text-amber-800">示例 CVE 建议</div>
          {% if result.cve_matches %}
            <div class="mt-2 space-y-2">
              {% for svc, items in result.cve_matches.items() %}
                <div class="rounded-lg border border-amber-200 bg-white/70 p-3">
                  <div class="text-xs font-semibold text-amber-700 uppercase">{{ svc }}</div>
                  <ul class="mt-1 space-y-1 text-sm text-amber-800">
                    {% for item in items %}
                      <li>• {{ item.cve_id }} — {{ item.desc }}</li>
                    {% endfor %}
                  </ul>
                </div>
              {% endfor %}
            </div>
          {% else %}
            <div class="mt-2 text-sm text-amber-700">未检索到相关 CVE 示例。</div>
          {% endif %}
        </div>

        <div class="rounded-xl border border-slate-200 bg-white/60 shadow-sm backdrop-blur px-4 py-3">
          <div class="text-sm font-semibold text-slate-800">nmap 原始输出</div>
          <pre class="mt-2 whitespace-pre-wrap break-words text-xs text-slate-800 bg-slate-50 rounded-lg p-3 border border-slate-100">{{ result.raw_nmap_output }}</pre>
        </div>
      </div>
    </div>
  {% else %}
    <div class="rounded-lg border border-slate-200 bg-white/70 px-4 py-3 text-slate-600">
      等待输入目标并开始分析。
    </div>
  {% endif %}
</div>
{%- endmacro %}

{% if render_partial %}
  {{ render_results(target, error, result) }}
{% else %}
<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AI 渗透测试助手（演示版）</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/htmx.org@1.9.12"></script>
    <link rel="stylesheet" href="/static/style.css" />
  </head>
  <body class="min-h-screen bg-gradient-to-br from-slate-50 to-emerald-50 text-slate-900">
    <div class="mx-auto max-w-5xl px-4 py-8">
      <header class="mb-6 space-y-2">
        <nav class="mb-4 flex items-center gap-4">
          <a href="/" class="text-sm font-semibold text-emerald-700">首页</a>
          <span class="text-slate-400">|</span>
          <a href="/logs" class="text-sm text-slate-600 hover:text-slate-900">查看日志</a>
          <span class="text-slate-400">|</span>
          <a href="/history" class="text-sm text-slate-600 hover:text-slate-900">历史报告</a>
        </nav>
        <div class="flex items-center justify-between gap-2">
          <h1 class="text-2xl font-bold text-slate-900">AI 渗透测试助手（演示版）</h1>
          <span class="rounded-full bg-emerald-100 px-3 py-1 text-xs font-semibold text-emerald-700 border border-emerald-200">本地运行</span>
        </div>
        <div class="flex items-center gap-2 rounded-lg border border-amber-200 bg-amber-50 px-3 py-2 text-amber-800 text-sm">
          <span class="text-lg">⚠️</span>
          <span>仅限授权目标使用！禁止对未授权系统扫描。</span>
        </div>
        {% if last_task_status and last_task_status.status %}
          <div class="mt-2 rounded-lg border px-3 py-2 text-sm
            {% if last_task_status.status == 'success' %}border-emerald-200 bg-emerald-50 text-emerald-800{% elif last_task_status.status == 'failed' %}border-red-200 bg-red-50 text-red-800{% else %}border-blue-200 bg-blue-50 text-blue-800{% endif %}">
            <span class="font-semibold">最近任务:</span>
            {% if last_task_status.status == 'success' %}
              <span>✅ 成功扫描 {{ last_task_status.target }}</span>
            {% elif last_task_status.status == 'failed' %}
              <span>❌ 失败: {{ last_task_status.error or '未知错误' }}</span>
            {% else %}
              <span>⏳ 进行中: {{ last_task_status.target }}</span>
            {% endif %}
          </div>
        {% endif %}
      </header>

      <section class="rounded-2xl border border-slate-200 bg-white/70 shadow-md backdrop-blur px-5 py-6">
        <form
          hx-post="/scan"
          hx-target="#results"
          hx-swap="innerHTML"
          hx-indicator="#loading"
          hx-disabled-elt="button"
          method="post"
          class="space-y-4"
          onsubmit="const btn=this.querySelector('button[type=submit]'); if(btn){btn.dataset.label=btn.innerText; btn.innerText='分析中...'; btn.disabled=true;}"
        >
          <div class="flex flex-col gap-2">
            <label for="target" class="text-sm font-semibold text-slate-800">Target</label>
            <input
              id="target"
              name="target"
              type="text"
              placeholder="example.com 或 192.168.1.1"
              required
              value="{{ target }}"
              class="w-full rounded-lg border border-slate-300 px-3 py-2 text-slate-900 shadow-sm focus:border-emerald-500 focus:ring-2 focus:ring-emerald-200"
            />
            <p class="text-xs text-slate-500">目标必须在 allowlist.txt 中，且仅限授权范围。</p>
          </div>

          <div class="flex items-center gap-3">
            <button
              type="submit"
              class="inline-flex items-center gap-2 rounded-lg bg-emerald-600 px-4 py-2 text-sm font-semibold text-white shadow-sm hover:bg-emerald-700 focus:outline-none focus:ring-2 focus:ring-emerald-300 disabled:opacity-60"
            >
              <span class="htmx-indicator hidden" id="loading">
                <span class="loading-dot"></span>
                <span class="loading-dot"></span>
                <span class="loading-dot"></span>
              </span>
              <span>开始分析</span>
            </button>
            <span class="text-xs text-slate-500">提交后自动校验 allowlist，并调用 nmap + RAG + Ollama。</span>
          </div>
        </form>

        <div id="results" class="mt-6">
          {{ render_results(target, error, result) }}
        </div>
      </section>
    </div>
  </body>
</html>
{% endif %}

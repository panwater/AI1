import argparse
import sys

from core.orchestrator import Orchestrator
from security.auth_check import is_target_allowed


def parse_args() -> argparse.Namespace:
    parser = argparse.ArgumentParser(
        description="Minimal AI-driven automated pentest PoC using Ollama + nmap"
    )
    parser.add_argument(
        "--target",
        required=True,
        help="Target domain or IP (must be in allowlist.txt)",
    )
    return parser.parse_args()


def main() -> None:
    args = parse_args()
    target = args.target.strip()

    # 1. 检查目标是否在 allowlist 中
    if not is_target_allowed(target):
        print(f"[ERROR] 目标未被授权或格式非法: {target}")
        sys.exit(1)

    orchestrator = Orchestrator()
    report = orchestrator.run(target)

    print("========== AI 风险评估报告 ==========")
    print(report)
    print("====================================")


if __name__ == "__main__":
    main()

